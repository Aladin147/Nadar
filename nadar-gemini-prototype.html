<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nadar - Gemini 2.5 Flash Prototype</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
        }

        .output-section {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 15px;
            border: 2px solid #28a745;
        }

        .section-title {
            font-size: 1.4em;
            margin-bottom: 20px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            background: #ecf0f1;
            border-color: #2980b9;
        }

        .upload-area.dragover {
            background: #d5dbdb;
            border-color: #27ae60;
        }

        input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 15px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1em;
            resize: vertical;
            margin-bottom: 15px;
        }

        .test-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        button {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .response-area {
            background: white;
            border: 2px solid #28a745;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            font-size: 1.1em;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .audio-controls {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #17a2b8;
        }

        .audio-controls.show {
            display: block;
        }

        .tts-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .tts-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .tts-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .audio-player {
            margin-top: 10px;
            width: 100%;
        }

        /* MVP Simulation Panel */
        .mvp-panel {
            margin: 20px 30px 30px;
            padding: 20px;
            border-radius: 14px;
            border: 2px solid #6c63ff;
            background: #f4f3ff;
        }
        .mvp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }
        .mvp-card {
            background: #fff;
            border: 1px solid #e8e8ff;
            border-radius: 10px;
            padding: 14px;
        }
        .mvp-card h3 {
            font-size: 1.05em;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .mvp-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }
        .mvp-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .mvp-chip {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 999px;
            background: #eef1ff;
            color: #333;
            font-size: 0.85em;
            margin-right: 8px;
        }
        .mvp-small {
            font-size: 0.9em;
            color: #555;
        }
        .mvp-label { font-weight: 600; font-size: 0.95em; margin-bottom: 4px; display:block; }
        .mvp-input, .mvp-select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #d6d6ff;
            border-radius: 8px;
            font-size: 0.95em;
            background: #fff;
        }
        .mvp-section-title { font-weight: 700; margin: 0 0 10px; color: #3f3d56; }
        .mvp-divider { height: 1px; background: #e6e6ff; margin: 12px 0; }
        .latency-list { list-style: none; padding: 0; margin: 0; }
        .latency-list li { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .ok { color: #28a745; }
        .warn { color: #e67e22; }
        .bad { color: #dc3545; }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin: 15px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .test-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ŸÜÿ∏ÿ± - Nadar</h1>
            <p>Gemini 2.5 Flash Prototype Testing Environment</p>
        </div>

        <div class="main-content">
            <div class="input-section">
                <h2 class="section-title">üì§ Input & Testing</h2>

                <div class="upload-area" onclick="document.getElementById('imageInput').click()">
                    <div class="upload-icon">üì∑</div>
                    <p><strong>Click to upload an image</strong></p>
                    <p>Or drag and drop an image here</p>
                    <input type="file" id="imageInput" accept="image/*">
                </div>

                <div id="imagePreview"></div>

                <div style="margin-bottom: 20px;">
                    <label for="systemPrompt" style="display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50;">
                        üéØ System Prompt (Instructions for Gemini):
                    </label>
                    <textarea id="systemPrompt" placeholder="Enter system instructions to control how Gemini responds...

Example system prompts:
- You are a helpful AI assistant for blind users. Keep responses concise, structured, and actionable.
- ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÑŸÑŸÖŸÉŸÅŸàŸÅŸäŸÜ. ÿßÿ¨ÿπŸÑ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ ŸÇÿµŸäÿ±ÿ© ŸàŸÖŸÜÿ∏ŸÖÿ© ŸàŸÖŸÅŸäÿØÿ©.
- Respond in 3 short bullet points maximum.
- Always start with the most important information first." style="min-height: 100px; font-size: 0.9em; border-color: #e74c3c;"></textarea>
                </div>

                <div style="margin-bottom: 20px;">
                    <label for="customPrompt" style="display: block; font-weight: bold; margin-bottom: 8px; color: #2c3e50;">
                        üí¨ User Prompt (Your Question):
                    </label>
                    <textarea id="customPrompt" style="min-height: 80px;" placeholder="Enter your question or request in English or Arabic/Darija...

Examples:
- ŸàÿµŸÅ ŸÑŸä ŸáÿßÿØ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ© ÿßŸÑŸÖÿ∫ÿ±ÿ®Ÿäÿ©
- What do you see in this image?
- ÿßŸÇÿ±ÿß ŸÑŸä ÿßŸÑŸÜÿµ ÿßŸÑŸÑŸä ŸÅŸáÿßÿØ ÿßŸÑÿµŸàÿ±ÿ©
- Help me navigate this scene"></textarea>
                </div>

                <div class="test-buttons">
                    <button class="btn-primary" onclick="testSceneDescription()">
                        üîç Scene Description
                    </button>
                    <button class="btn-success" onclick="testOCR()">
                        üìñ Read Text (OCR)
                    </button>
                    <button class="btn-warning" onclick="testDarijaResponse()">
                        üó£Ô∏è Darija Response
                    </button>
                    <button class="btn-info" onclick="testCustomPrompt()">
                        üí¨ Custom Question
                    </button>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <button class="btn-info" onclick="loadPresetSystemPrompts()" style="font-size: 0.9em;">
                        üìã Load Preset Prompts
                    </button>
                    <button class="btn-primary" onclick="clearAll()">
                        üóëÔ∏è Clear All
                    </button>
                </div>

                <!-- MVP Simulation Panel -->
                <div class="mvp-panel" id="mvpPanel">
                    <h2 class="section-title">üß™ MVP Simulation</h2>
                    <p class="mvp-small">Simulate the MVP flows and constraints without leaving this prototype.</p>
                    <div class="mvp-grid">
                        <div class="mvp-card">
                            <h3>Modes & Prompts</h3>
                            <div class="mvp-row">
                                <div>
                                    <label class="mvp-label">Mode</label>
                                    <select id="mvpMode" class="mvp-select">
                                        <option value="scene">Scene Description</option>
                                        <option value="ocr">OCR</option>
                                        <option value="qa">Follow-up Q&A</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="mvp-label">Verbosity</label>
                                    <select id="mvpVerbosity" class="mvp-select">
                                        <option value="brief">Brief (3 bullets)</option>
                                        <option value="normal" selected>Normal</option>
                                        <option value="detailed">Detailed</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="mvp-label">System Prompt Preset</label>
                                <select id="mvpPromptPreset" class="mvp-select">
                                    <option value="safety">Safety-first: IMMEDIATE/OBJECTS/NAVIGATION</option>
                                    <option value="ocr">OCR: Summary + ask for full readout</option>
                                    <option value="qa">Q&A: one sentence + suggest reframe if uncertain</option>
                                </select>
                            </div>
                            <div class="mvp-actions">
                                <button class="btn-primary" onclick="mvpApplyPreset()">Apply Preset</button>
                                <button class="btn-success" onclick="mvpRun()">Run Mode</button>
                                <button class="btn-warning" onclick="mvpReset()">Reset</button>
                            </div>
                        </div>
                        <div class="mvp-card">
                            <h3>Latency Target</h3>
                            <div class="mvp-row">
                                <div>
                                    <label class="mvp-label">Budget (P50)</label>
                                    <input id="mvpP50" class="mvp-input" type="number" value="3500" />
                                </div>
                                <div>
                                    <label class="mvp-label">Budget (P95)</label>
                                    <input id="mvpP95" class="mvp-input" type="number" value="5500" />
                                </div>
                            </div>
                            <div class="mvp-row">
                                <div>
                                    <label class="mvp-label">Downscale (px)</label>
                                    <input id="mvpMaxDim" class="mvp-input" type="number" value="1024" />
                                </div>
                                <div>
                                    <label class="mvp-label">JPEG Quality</label>
                                    <input id="mvpJpegQ" class="mvp-input" type="number" value="80" />
                                </div>
                            </div>
                            <div>
                                <div class="mvp-section-title">Last Run</div>
                                <ul class="latency-list" id="mvpLatencyList"></ul>
                            </div>
                        </div>
                        <div class="mvp-card">
                            <h3>Cost & Tokens (est.)</h3>
                            <div class="mvp-row">
                                <div>
                                    <label class="mvp-label">Input tokens</label>
                                    <input id="mvpInTok" class="mvp-input" type="number" readonly />
                                </div>
                                <div>
                                    <label class="mvp-label">Output tokens</label>
                                    <input id="mvpOutTok" class="mvp-input" type="number" readonly />
                                </div>
                            </div>
                            <div class="mvp-row">
                                <div>
                                    <label class="mvp-label">Vision cost ($)</label>
                                    <input id="mvpVisionCost" class="mvp-input" type="text" readonly />
                                </div>
                                <div>
                                    <label class="mvp-label">TTS cost ($)</label>
                                    <input id="mvpTTSCost" class="mvp-input" type="text" readonly />
                                </div>
                            </div>
                            <div>
                                <span class="mvp-chip" id="mvpProvider">Gemini 2.5 Flash</span>
                                <span class="mvp-chip">TTS</span>
                                <span class="mvp-chip">Ephemeral</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="output-section">
                <h2 class="section-title">üì§ Gemini Response</h2>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Processing with Gemini 2.5 Flash...</p>
                </div>

                <div class="response-area" id="responseArea">
                    Welcome to the Nadar prototype testing environment!

                    Upload an image and try different test scenarios:

                    üîç Scene Description - Get detailed scene descriptions
                    üìñ OCR - Extract and read text from images
                    üó£Ô∏è Darija Response - Test Moroccan Arabic responses
                    üí¨ Custom Question - Ask specific questions

                    This will help us evaluate Gemini 2.5 Flash for the Nadar project.
                </div>

                <div class="audio-controls" id="audioControls">
                    <button class="tts-button" id="playAudioBtn" onclick="convertToSpeech()">
                        üîä Play Audio
                    </button>
                    <button class="tts-button" id="stopAudioBtn" onclick="stopAudio()" style="background: linear-gradient(135deg, #dc3545, #c82333);">
                        ‚èπÔ∏è Stop
                    </button>
                    <audio id="audioPlayer" class="audio-player" controls style="display: none;">
                        Your browser does not support the audio element.
                    </audio>
                    <div id="ttsStatus" style="margin-top: 10px; font-size: 0.9em; color: #6c757d;"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Initialize Gemini API
        const API_KEY = "AIzaSyAYDfa4radeqQS7dVMFN8Vyer1gSqCN_0Q";
        const genAI = new GoogleGenerativeAI(API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
        const ttsModel = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-tts" });

        let currentImage = null;
        let currentImageData = null;
        let currentResponseText = null;
        let currentAudio = null;

        // File upload handling
        const imageInput = document.getElementById('imageInput');
        const uploadArea = document.querySelector('.upload-area');
        const imagePreview = document.getElementById('imagePreview');
        const responseArea = document.getElementById('responseArea');
        const loading = document.getElementById('loading');

        imageInput.addEventListener('change', handleImageUpload);

        // Drag and drop functionality
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFile(files[0]);
            }
        });

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleImageFile(file);
            }
        }

        function handleImageFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                currentImageData = {
                    inlineData: {
                        data: currentImage.split(',')[1],
                        mimeType: file.type
                    }
                };

                // Show preview
                imagePreview.innerHTML = `<img src="${currentImage}" class="image-preview" alt="Uploaded image">`;
            };
            reader.readAsDataURL(file);
        }

        async function callGemini(prompt, includeImage = true) {
            if (!currentImageData && includeImage) {
                showError('Please upload an image first.');
                return;
            }

            showLoading(true);

            try {
                // Get system prompt
                const systemPrompt = document.getElementById('systemPrompt').value.trim();

                // Combine system prompt with user prompt
                let finalPrompt = prompt;
                if (systemPrompt) {
                    finalPrompt = `SYSTEM INSTRUCTIONS: ${systemPrompt}\n\nUSER REQUEST: ${prompt}`;
                }

                const parts = [finalPrompt];
                if (includeImage && currentImageData) {
                    parts.push(currentImageData);
                }

                const result = await model.generateContent(parts);
                const response = await result.response;
                const text = response.text();

                showResponse(text);
            } catch (error) {
                console.error('Error calling Gemini:', error);
                showError(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // Test functions
        window.testSceneDescription = () => {
            const prompt = `Describe this image for navigation assistance. Focus on:

            1. Overall scene and environment
            2. Objects and their locations
            3. People and their activities
            4. Text or signs visible
            5. Potential navigation hazards or helpful landmarks`;

            callGemini(prompt);
        };

        // =============== MVP Simulation Logic ===============
        function mvpApplyPreset() {
            const preset = document.getElementById('mvpPromptPreset')?.value;
            const sysEl = document.getElementById('systemPrompt');
            if (!sysEl) return;
            if (preset === 'safety') {
                sysEl.value = 'You are Nadar, assisting blind users. Respond in Darija when possible. Format: IMMEDIATE: [urgent info]; OBJECTS: [up to 2 bullets]; NAVIGATION: [1 sentence]. Keep each part short and practical. Do not identify people or read private screens. Express uncertainty when not sure.';
            } else if (preset === 'ocr') {
                sysEl.value = 'Extract text. Summarize in 2 bullets. Ask: ‚ÄúBghiti ŸÜŸÇÿ±ÿß ŸÑŸÉ ÿßŸÑŸÜÿµ ŸÉÿßŸÖŸÑÿü‚Äù Keep it concise; include language hints if mixed.';
            } else if (preset === 'qa') {
                sysEl.value = 'Answer in 1 short sentence. If uncertain, say you are not sure and propose 1 clarifying question. Keep tone helpful and safe.';
            }
        }

        async function mvpRun() {
            const mode = document.getElementById('mvpMode')?.value || 'scene';
            const verbosity = document.getElementById('mvpVerbosity')?.value || 'normal';
            const maxDim = parseInt(document.getElementById('mvpMaxDim')?.value || '1024', 10);
            const jpegQ = Math.min(100, Math.max(1, parseInt(document.getElementById('mvpJpegQ')?.value || '80', 10)));

            const t0 = performance.now();
            // Simulated client prep time
            const prepMs = Math.round(Math.random() * 80) + 120;

            // Mode prompts
            let userPrompt = '';
            if (mode === 'scene') {
                userPrompt = 'Describe the scene for safe navigation.';
            } else if (mode === 'ocr') {
                userPrompt = 'Extract visible text and summarize.';
            } else {
                const cp = document.getElementById('customPrompt')?.value.trim();
                userPrompt = cp || 'Answer a brief follow-up question about the previous image.';
            }
            if (verbosity === 'brief') userPrompt += ' Keep response to max 3 short bullet points.';
            if (verbosity === 'detailed') userPrompt += ' Provide more detail but remain structured and concise.';

            const t1 = performance.now();
            await callGemini(userPrompt, mode !== 'qa');
            const t2 = performance.now();

            // Token and cost estimates
            const outLen = (currentResponseText || '').length;
            const outTok = Math.ceil(outLen / 4);
            const inTok = 600;
            const visionCost = ((inTok / 1_000_000) * 0.30) + ((outTok / 1_000_000) * 2.50);
            const ttsCost = ((outTok / 1_000_000) * 10.0);

            // Update UI
            const list = document.getElementById('mvpLatencyList');
            if (list) {
                const prep = Math.round(prepMs);
                const model = Math.round(t2 - t1);
                const total = Math.round((t2 - t0) + prep);
                list.innerHTML = `
                    <li><span>Prep (downscale ${maxDim}px @ Q${jpegQ})</span><span class="${prep < 300 ? 'ok' : prep < 600 ? 'warn' : 'bad'}">${prep} ms</span></li>
                    <li><span>Model</span><span class="${model < 2200 ? 'ok' : model < 3500 ? 'warn' : 'bad'}">${model} ms</span></li>
                    <li><span>Total (Tap‚ÜíText)</span><span class="${total < 3500 ? 'ok' : total < 5500 ? 'warn' : 'bad'}">${total} ms</span></li>
                `;
            }

            const inTokEl = document.getElementById('mvpInTok');
            const outTokEl = document.getElementById('mvpOutTok');
            const vCostEl = document.getElementById('mvpVisionCost');
            const ttsCostEl = document.getElementById('mvpTTSCost');
            if (inTokEl) inTokEl.value = inTok;
            if (outTokEl) outTokEl.value = outTok;
            if (vCostEl) vCostEl.value = visionCost.toFixed(5);
            if (ttsCostEl) ttsCostEl.value = ttsCost.toFixed(5);
        }

        function mvpReset() {
            const list = document.getElementById('mvpLatencyList');
            if (list) list.innerHTML = '';
            const ids = ['mvpInTok','mvpOutTok','mvpVisionCost','mvpTTSCost'];
            ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        }

        window.testOCR = () => {
            const prompt = `Extract and read all text visible in this image. Focus on:
            - Signs and labels
            - Documents or papers
            - Menu items
            - Street signs
            - Any written information

            If text is in Arabic/French, provide translation.`;

            callGemini(prompt);
        };

        window.testDarijaResponse = () => {
            const prompt = `ŸàÿµŸÅ ŸÑŸä ŸáÿßÿØ ÿßŸÑÿµŸàÿ±ÿ© ÿ®ÿßŸÑÿØÿßÿ±ÿ¨ÿ© ÿßŸÑŸÖÿ∫ÿ±ÿ®Ÿäÿ©. ÿ±ŸÉÿ≤ ÿπŸÑŸâ:
            - ÿßŸÑŸÖŸÉÿßŸÜ ŸàÿßŸÑÿ®Ÿäÿ¶ÿ© ÿßŸÑÿπÿßŸÖÿ©
            - ÿßŸÑÿ≠ŸàÿßŸäÿ¨ ÿßŸÑŸÑŸä ŸÉÿßŸäŸÜŸäŸÜ ŸàŸÅŸäŸÜ ŸÉÿßŸäŸÜŸäŸÜ
            - ÿßŸÑŸÜÿßÿ≥ Ÿàÿ£ÿ¥ ŸÉŸäÿØŸäÿ±Ÿà
            - ÿ£Ÿä ŸÉÿ™ÿßÿ®ÿ© ÿ£Ÿà ÿπŸÑÿßŸÖÿßÿ™
            - ÿ£Ÿä ÿÆÿ∑ÿ± ÿ£Ÿà ÿ≠ÿßÿ¨ÿ© ŸÖŸÅŸäÿØÿ© ŸÑŸÑÿ™ŸÜŸÇŸÑ`;

            callGemini(prompt);
        };

        window.testCustomPrompt = () => {
            const customPrompt = document.getElementById('customPrompt').value.trim();
            if (!customPrompt) {
                showError('Please enter a custom prompt first.');
                return;
            }

            callGemini(customPrompt);
        };

        window.loadPresetSystemPrompts = () => {
            const presets = [
                "You are Nadar, an AI assistant for blind users in Morocco. Keep responses concise (max 3 bullet points), structured, and actionable. Always prioritize safety information first.",
                "ÿ£ŸÜÿ™ ŸÜÿ∏ÿ±ÿå ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÑŸÑŸÖŸÉŸÅŸàŸÅŸäŸÜ ŸÅÿßŸÑŸÖÿ∫ÿ±ÿ®. ÿßÿ¨ÿπŸÑ ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ ŸÇÿµŸäÿ±ÿ© (3 ŸÜŸÇÿ∑ ÿ®ÿ≠ÿØ ÿ£ŸÇÿµŸâ)ÿå ŸÖŸÜÿ∏ŸÖÿ©ÿå ŸàŸÖŸÅŸäÿØÿ©. ÿßÿ®ÿØÿß ÿØŸäŸÖÿß ÿ®ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ŸÖÿßŸÜ.",
                "Respond in exactly 3 short bullet points. Start with the most important safety or navigation information. Use simple, clear language.",
                "Format your response as: IMMEDIATE: [urgent info], OBJECTS: [key items], NAVIGATION: [movement guidance]. Keep each section to one sentence.",
                "You are helping a blind person navigate. Be their eyes. Speak naturally and conversationally. Focus on what matters most for safe movement."
            ];

            let selection = prompt(`Choose a preset system prompt (1-5):\n\n1. Nadar Assistant (English)\n2. ŸÜÿ∏ÿ± ÿßŸÑŸÖÿ≥ÿßÿπÿØ (Arabic)\n3. 3 Bullet Points\n4. Structured Format\n5. Conversational Guide\n\nEnter number (1-5):`);

            if (selection && selection >= 1 && selection <= 5) {
                document.getElementById('systemPrompt').value = presets[selection - 1];
            }
        };

        window.clearAll = () => {
            currentImage = null;
            currentImageData = null;
            imagePreview.innerHTML = '';
            document.getElementById('customPrompt').value = '';
            document.getElementById('systemPrompt').value = '';
            responseArea.textContent = `Welcome to the Nadar prototype testing environment!

Upload an image and try different test scenarios:

üîç Scene Description - Get detailed scene descriptions
üìñ OCR - Extract and read text from images
üó£Ô∏è Darija Response - Test Moroccan Arabic responses
üí¨ Custom Question - Ask specific questions

Now with System Prompt control and TTS testing!`;
            imageInput.value = '';

            // Hide audio controls and reset audio
            document.getElementById('audioControls').classList.remove('show');
            stopAudio();
            currentResponseText = null;
        };

        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            responseArea.style.display = show ? 'none' : 'block';
        }

        function showResponse(text) {
            currentResponseText = text;
            responseArea.textContent = text;
            responseArea.scrollTop = 0;

            // Show audio controls if we have text
            if (text && text.trim()) {
                document.getElementById('audioControls').classList.add('show');
            }
        }

        function showError(message) {
            responseArea.innerHTML = `<div class="error">${message}</div>`;
            document.getElementById('audioControls').classList.remove('show');
        }

        // TTS Functions
        window.convertToSpeech = async () => {
            if (!currentResponseText || !currentResponseText.trim()) {
                showTTSStatus('No text to convert to speech', 'error');
                return;
            }

            const playBtn = document.getElementById('playAudioBtn');
            const stopBtn = document.getElementById('stopAudioBtn');
            const audioPlayer = document.getElementById('audioPlayer');

            try {
                playBtn.disabled = true;
                showTTSStatus('Converting text to speech...', 'loading');

                // Call Gemini TTS API with proper configuration for audio output
                const result = await ttsModel.generateContent({
                    contents: [{
                        role: 'user',
                        parts: [{ text: currentResponseText }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: {
                                    voiceName: "Kore"
                                }
                            }
                        }
                    }
                });

                const response = await result.response;

                // Get the audio data from the response
                const audioData = response.candidates[0].content.parts[0].inlineData.data;

                // Convert base64 to raw bytes
                const rawAudioData = Uint8Array.from(atob(audioData), c => c.charCodeAt(0));

                // Convert L16 PCM to WAV format
                const wavData = convertL16ToWav(rawAudioData);

                // Create audio blob and URL
                const audioBlob = new Blob([wavData], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);

                // Set up audio player
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                currentAudio = audioPlayer;

                // Play audio
                await audioPlayer.play();
                showTTSStatus('Playing audio...', 'success');

                // Handle audio end
                audioPlayer.onended = () => {
                    showTTSStatus('Audio playback completed', 'success');
                    playBtn.disabled = false;
                };

            } catch (error) {
                console.error('TTS Error:', error);
                showTTSStatus(`TTS Error: ${error.message}`, 'error');
                playBtn.disabled = false;
            }
        };

        window.stopAudio = () => {
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playAudioBtn');

            if (audioPlayer && !audioPlayer.paused) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                showTTSStatus('Audio stopped', 'info');
            }

            playBtn.disabled = false;
        };

        function showTTSStatus(message, type = 'info') {
            const statusDiv = document.getElementById('ttsStatus');
            statusDiv.textContent = message;

            // Color coding based on type
            switch(type) {
                case 'error':
                    statusDiv.style.color = '#dc3545';
                    break;
                case 'success':
                    statusDiv.style.color = '#28a745';
                    break;
                case 'loading':
                    statusDiv.style.color = '#17a2b8';
                    break;
                default:
                    statusDiv.style.color = '#6c757d';
            }
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);

            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }

            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // Convert L16 PCM to WAV format (based on Gemini TTS output format)
        function convertL16ToWav(inputData, sampleRate = 24000, numChannels = 1) {
            const bitsPerSample = 16;
            const blockAlign = numChannels * bitsPerSample / 8;
            const byteRate = sampleRate * blockAlign;
            const dataSize = inputData.length;
            const fileSize = 36 + dataSize;

            // Create WAV header
            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            // RIFF header
            view.setUint8(0, 0x52); // R
            view.setUint8(1, 0x49); // I
            view.setUint8(2, 0x46); // F
            view.setUint8(3, 0x46); // F
            view.setUint32(4, fileSize, true); // File size
            view.setUint8(8, 0x57); // W
            view.setUint8(9, 0x41); // A
            view.setUint8(10, 0x56); // V
            view.setUint8(11, 0x45); // E

            // fmt chunk
            view.setUint8(12, 0x66); // f
            view.setUint8(13, 0x6d); // m
            view.setUint8(14, 0x74); // t
            view.setUint8(15, 0x20); // (space)
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, 1, true); // PCM format
            view.setUint16(22, numChannels, true); // Number of channels
            view.setUint32(24, sampleRate, true); // Sample rate
            view.setUint32(28, byteRate, true); // Byte rate
            view.setUint16(32, blockAlign, true); // Block align
            view.setUint16(34, bitsPerSample, true); // Bits per sample

            // data chunk
            view.setUint8(36, 0x64); // d
            view.setUint8(37, 0x61); // a
            view.setUint8(38, 0x74); // t
            view.setUint8(39, 0x61); // a
            view.setUint32(40, dataSize, true); // Data size

            // Combine header and data
            const wavData = new Uint8Array(44 + dataSize);
            wavData.set(new Uint8Array(header), 0);
            wavData.set(inputData, 44);

            return wavData;
        }
    </script>
</body>
</html>
