@echo off
echo ðŸš€ Starting Nadar Development Pipeline with ngrok...
echo.

REM Kill any existing processes
taskkill /f /im ngrok.exe >nul 2>&1
taskkill /f /im node.exe >nul 2>&1

echo ðŸŒ Starting ngrok tunnel...
start /B ngrok http 4000

echo â³ Waiting for ngrok to initialize...
timeout /t 5 /nobreak >nul

REM Get ngrok URL and update app config
echo ðŸ“ Getting ngrok URL and updating app configuration...
node -e "
const https = require('https');
const fs = require('fs');

setTimeout(async () => {
  try {
    const response = await fetch('http://localhost:4040/api/tunnels');
    const data = await response.json();
    const tunnel = data.tunnels.find(t => t.config.addr === 'localhost:4000');
    
    if (tunnel) {
      const ngrokUrl = tunnel.public_url;
      console.log('âœ… ngrok URL:', ngrokUrl);
      
      const envContent = '# Auto-generated by dev-tunnel.bat\nEXPO_PUBLIC_API_BASE=' + ngrokUrl + '\n';
      fs.writeFileSync('app/.env', envContent);
      console.log('âœ… App configuration updated');
    } else {
      console.log('âŒ Could not get ngrok URL');
    }
  } catch (error) {
    console.log('âŒ Error:', error.message);
  }
}, 3000);
"

echo.
echo ðŸ–¥ï¸  Starting server...
start /B cmd /c "cd server && npm run dev"

timeout /t 3 /nobreak >nul

echo.
echo ðŸ“± Starting Expo with tunnel...
cd app
start /B cmd /c "npx expo start --tunnel"

echo.
echo ðŸŽ‰ Development pipeline started!
echo ðŸ“‹ All services are starting in background...
echo ðŸ’¡ Check the Expo terminal for QR code
echo ðŸ’¡ Press any key to stop all services
pause >nul

echo.
echo ðŸ§¹ Stopping all services...
taskkill /f /im ngrok.exe >nul 2>&1
taskkill /f /im node.exe >nul 2>&1
echo âœ… All services stopped
